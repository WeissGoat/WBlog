<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ç™½å±±ç¾Š</title><link>https://WeissGoat.github.io/WBlog/</link><description>Recent content on ç™½å±±ç¾Š</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Mon, 05 Feb 2024 18:00:00 +0800</lastBuildDate><atom:link href="https://WeissGoat.github.io/WBlog/index.xml" rel="self" type="application/rss+xml"/><item><title>Lua GC</title><link>https://WeissGoat.github.io/WBlog/p/lua-gc/</link><pubDate>Mon, 05 Feb 2024 18:00:00 +0800</pubDate><guid>https://WeissGoat.github.io/WBlog/p/lua-gc/</guid><description>&lt;h1 id="lua-gc-ä¸‰è‰²æ ‡è®°å¢é‡å›æ”¶ä¸å†™å±éšœ"&gt;Lua GC ï¼šä¸‰è‰²æ ‡è®°ã€å¢é‡å›æ”¶ä¸å†™å±éšœ
&lt;/h1&gt;&lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº† Lua çš„æ•°æ®ç»“æ„ï¼ˆ&lt;code&gt;TValue&lt;/code&gt;ï¼‰ä»¥åŠå“ªäº›å¯¹è±¡æ˜¯å€¼ç±»å‹ï¼Œå“ªäº›æ˜¯å¼•ç”¨ç±»å‹ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬ç»§ç»­å‘ä¸‹æŒ–æ˜ï¼ŒèŠèŠ Lua è™šæ‹Ÿæœºä¸­çš„&lt;strong&gt;åƒåœ¾å›æ”¶æœºåˆ¶ï¼ˆGarbage Collectionï¼‰&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h2 id="ä»-stop-the-world-åˆ°å¢é‡"&gt;ä» Stop-the-World åˆ°å¢é‡
&lt;/h2&gt;&lt;h3 id="lua-50ç®€å•çš„ä»£ä»·"&gt;Lua 5.0ï¼šç®€å•çš„ä»£ä»·
&lt;/h3&gt;&lt;p&gt;åœ¨ Lua 5.0 æ—¶ä»£ï¼ŒGC ç®—æ³•éå¸¸æœ´ç´ ï¼š&lt;strong&gt;åŒå€é˜ˆå€¼ï¼Œå…¨é‡å›æ”¶&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;é€»è¾‘&lt;/strong&gt;ï¼šå½“å†…å­˜ä½¿ç”¨é‡è¾¾åˆ°ä¸Šæ¬¡ GC åçš„ä¸¤å€æ—¶ï¼Œè™šæ‹Ÿæœºæš‚åœæ‰€æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œè·‘ä¸€éå®Œæ•´çš„â€œæ ‡è®°-æ¸…é™¤â€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;åæœ&lt;/strong&gt;ï¼šè¿™å°±æ˜¯è‘—åçš„ &lt;strong&gt;Stop-the-World (STW)&lt;/strong&gt;ã€‚å¦‚æœä½ çš„ Lua å†…å­˜å ç”¨äº† 1GBï¼ŒGC è§¦å‘çš„é‚£ä¸€ç¬é—´ï¼Œæ•´ä¸ªæ¸¸æˆæˆ–æœåŠ¡å¯èƒ½ä¼šå¡é¡¿å‡ ç™¾æ¯«ç§’ç”šè‡³æ›´ä¹…ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="lua-51ä¸‰è‰²å¢é‡æ ‡è®°tri-color-incremental-mark--sweep"&gt;Lua 5.1+ï¼šä¸‰è‰²å¢é‡æ ‡è®°ï¼ˆTri-color Incremental Mark &amp;amp; Sweepï¼‰
&lt;/h3&gt;&lt;p&gt;ä¸ºäº†è§£å†³å¡é¡¿ï¼ŒLua 5.1 å¼•å…¥äº†å¢é‡ GCã€‚GC è¿‡ç¨‹ä¸ä¸šåŠ¡ä»£ç äº¤æ›¿è¿è¡Œã€‚&lt;/p&gt;
&lt;p&gt;ä¸ºäº†å®ç°â€œå¯ä¸­æ–­ã€å¯æ¢å¤â€çš„æ‰«æï¼ŒLua å¼•å…¥äº†&lt;strong&gt;ä¸‰è‰²æ ‡è®°æ³•&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h2 id="æ ¸å¿ƒç®—æ³•ä¸‰è‰²æ ‡è®°ä¸åŒç™½è®¾è®¡"&gt;æ ¸å¿ƒç®—æ³•ï¼šä¸‰è‰²æ ‡è®°ä¸åŒç™½è®¾è®¡
&lt;/h2&gt;&lt;p&gt;GC çš„æœ¬è´¨æ˜¯ä»æ ¹èŠ‚ç‚¹ï¼ˆ_Gã€Registryã€æ ˆï¼‰å‡ºå‘ï¼Œæ‰¾åˆ°æ‰€æœ‰å¯è¾¾å¯¹è±¡ã€‚åœ¨å¢é‡æ‰«æè¿‡ç¨‹ä¸­ï¼Œå¯¹è±¡è¢«æ ‡è®°ä¸ºä¸‰ç§é¢œè‰²ï¼š&lt;/p&gt;
&lt;h3 id="é¢œè‰²çš„å«ä¹‰"&gt;é¢œè‰²çš„å«ä¹‰
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;âšª ç™½è‰² (White)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å«ä¹‰&lt;/strong&gt;ï¼šå½“å‰è¿˜æœªè¢« GC è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œæˆ–è€…å·²æ­»äº¡çš„å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;åˆå§‹çŠ¶æ€&lt;/strong&gt;ï¼šæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è±¡é»˜è®¤ä¸ºç™½è‰²ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç»“å±€&lt;/strong&gt;ï¼šå¦‚æœ GC ç»“æŸåè¿˜æ˜¯ç™½è‰²ï¼Œè¯´æ˜ä¸å¯è¾¾ï¼Œ&lt;strong&gt;å›æ”¶&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;âš« é»‘è‰² (Black)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å«ä¹‰&lt;/strong&gt;ï¼š&lt;strong&gt;å·²æ‰«æå®Œæ¯•&lt;/strong&gt;ã€‚è¯¥å¯¹è±¡åŠå…¶å¼•ç”¨çš„æ‰€æœ‰å­å¯¹è±¡éƒ½å·²ç»è¢«è®¿é—®è¿‡äº†ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç‰¹æ€§&lt;/strong&gt;ï¼šGC è¿™ä¸€è½®ä¸ä¼šå†å›å¤´çœ‹å®ƒã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ğŸ”˜ ç°è‰² (Gray)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å«ä¹‰&lt;/strong&gt;ï¼š&lt;strong&gt;å¾…å¤„ç†&lt;/strong&gt;ã€‚è¯¥å¯¹è±¡å·²è¢«è®¿é—®ï¼ˆä»ç™½è‰²å˜æˆäº†ç°è‰²ï¼‰ï¼Œä½†å®ƒå¼•ç”¨çš„å­å¯¹è±¡è¿˜æ²¡æ‰«æå®Œã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä½œç”¨&lt;/strong&gt;ï¼šç°è‰²æ˜¯å½“å‰æ‰«æçš„è¾¹ç¼˜ï¼ˆFrontierï¼‰ï¼Œä¿å­˜åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="å·§å¦™çš„åŒç™½è®¾è®¡-the-two-whites"&gt;å·§å¦™çš„â€œåŒç™½â€è®¾è®¡ (The Two Whites)
&lt;/h3&gt;&lt;p&gt;æˆ‘åœ¨ç ”ç©¶æºç æ—¶å‘ç°ä¸€ä¸ªæœ‰è¶£çš„ç»†èŠ‚ï¼šLua çš„ç™½è‰²å…¶å®ç»†åˆ†ä¸º &lt;strong&gt;White1&lt;/strong&gt; å’Œ &lt;strong&gt;White2&lt;/strong&gt;ã€‚è¿™æ˜¯ä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯&lt;/strong&gt;ï¼š GC æ ‡è®°é˜¶æ®µå·²ç»å¿«ç»“æŸäº†ï¼ˆå¤§éƒ¨åˆ†æ˜¯é»‘è‰²ï¼‰ï¼Œæ­¤æ—¶ä¸šåŠ¡ä»£ç çªç„¶åˆ›å»ºäº†ä¸€ä¸ªæ–°å¯¹è±¡ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ–°å¯¹è±¡é»˜è®¤æ˜¯&lt;strong&gt;ç™½è‰²&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœä¸åŠ åŒºåˆ†ï¼Œåœ¨æ¥ä¸‹æ¥çš„â€œæ¸…é™¤é˜¶æ®µâ€ï¼ŒGC ä¼šè®¤ä¸ºè¿™ä¸ªç™½è‰²çš„æ–°å¯¹è±¡æ˜¯â€œæ²¡è¢«å¼•ç”¨çš„åƒåœ¾â€å¹¶æŠŠå®ƒå›æ”¶æ‰â€”â€”&lt;strong&gt;è¿™ä¼šå¯¼è‡´ä¸¥é‡ Bug&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;è§£å†³æ–¹æ¡ˆ&lt;/strong&gt;ï¼š Lua ä½¿ç”¨ä¸€ä¸ªå…¨å±€çš„ä½æ©ç  &lt;code&gt;CurrentWhite&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æœ¬è½® GC&lt;/strong&gt;ï¼šåªå›æ”¶æ ‡è®°ä¸ºâ€œæ—§ç™½è‰²â€çš„å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ–°åˆ›å»ºå¯¹è±¡&lt;/strong&gt;ï¼šæ ‡è®°ä¸ºâ€œæ–°ç™½è‰²â€ï¼ˆCurrentWhiteï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç»“æœ&lt;/strong&gt;ï¼šæ–°å¯¹è±¡åœ¨æœ¬è½® GC ä¸­è¢«è§†ä¸ºâ€œå®‰å…¨â€ï¼Œç•™åˆ°ä¸‹ä¸€è½®å†å¤„ç†ã€‚åœ¨æ¸…é™¤é˜¶æ®µç»“æŸåï¼ŒLua ä¼šè½®è½¬ &lt;code&gt;CurrentWhite&lt;/code&gt; çš„å€¼ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="çŠ¶æ€æœºçš„æµè½¬gc-çš„ç”Ÿå‘½å‘¨æœŸ"&gt;çŠ¶æ€æœºçš„æµè½¬ï¼šGC çš„ç”Ÿå‘½å‘¨æœŸ
&lt;/h2&gt;&lt;p&gt;Lua çš„å¢é‡ GC æ˜¯é€šè¿‡ä¸€ä¸ªçŠ¶æ€æœºé©±åŠ¨çš„ã€‚æ¯æ¬¡è°ƒç”¨ &lt;code&gt;luaC_step&lt;/code&gt;ï¼ŒGC å°±ä¼šå‘å‰æ¨è¿›ä¸€æ­¥ã€‚ä»¥ä¸‹æ˜¯ä¸»è¦çš„é˜¶æ®µï¼š&lt;/p&gt;
&lt;h3 id="-gcspause-æš‚åœåˆå§‹åŒ–"&gt;â‘  GCSpause (æš‚åœ/åˆå§‹åŒ–)
&lt;/h3&gt;&lt;p&gt;GC çš„èµ·ç‚¹ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å°†æ ¹èŠ‚ç‚¹ï¼ˆä¸»çº¿ç¨‹ã€å…¨å±€è¡¨ _Gã€Registry ç­‰ï¼‰æ ‡è®°ä¸º&lt;strong&gt;ç°è‰²&lt;/strong&gt;ï¼Œå¹¶åŠ å…¥ç°è‰²é“¾è¡¨ã€‚&lt;/li&gt;
&lt;li&gt;æ­¤æ—¶ï¼Œé€šè¿‡æ ¹èŠ‚ç‚¹çš„ä¸€æ³¢æ“ä½œï¼Œæˆ‘ä»¬æœ‰äº†ç¬¬ä¸€æ‰¹å¾…æ‰«æçš„ç°è‰²å¯¹è±¡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="-gcspropagate-ä¼ æ’­---æœ€è€—æ—¶çš„é˜¶æ®µ"&gt;â‘¡ GCSpropagate (ä¼ æ’­ - æœ€è€—æ—¶çš„é˜¶æ®µ)
&lt;/h3&gt;&lt;p&gt;è¿™æ˜¯â€œå¢é‡â€ä½“ç°æœ€æ˜æ˜¾çš„åœ°æ–¹ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ“ä½œ&lt;/strong&gt;ï¼šä»ç°è‰²é“¾è¡¨ä¸­å¼¹å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œå°†å…¶æ ‡è®°ä¸º&lt;strong&gt;é»‘è‰²&lt;/strong&gt;ï¼Œç„¶åéå†å®ƒå¼•ç”¨çš„æ‰€æœ‰å­å¯¹è±¡ï¼š&lt;/li&gt;
&lt;li&gt;å¦‚æœæ˜¯ç™½è‰²ï¼Œå°†å…¶æŸ“æˆ&lt;strong&gt;ç°è‰²&lt;/strong&gt;å¹¶åŠ å…¥é“¾è¡¨ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ§åˆ¶&lt;/strong&gt;ï¼šè¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯ä¸€æ¬¡æ€§åšå®Œçš„ï¼Œè€Œæ˜¯å— &lt;code&gt;gcstepmul&lt;/code&gt; æ§åˆ¶ï¼Œæ¯æ¬¡åªå¤„ç†ä¸€éƒ¨åˆ†å°±æš‚åœï¼ŒæŠŠ CPU è®©ç»™ä¸šåŠ¡é€»è¾‘ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="-gcsatomic-åŸå­é˜¶æ®µ---å¿…é¡»ä¸€æ¬¡åšå®Œ"&gt;â‘¢ GCSatomic (åŸå­é˜¶æ®µ - å¿…é¡»ä¸€æ¬¡åšå®Œ)
&lt;/h3&gt;&lt;p&gt;è¿™æ˜¯è¿™ä¸€è½® GC ä¸­å”¯ä¸€éœ€è¦ Stop-the-World çš„æ—¶åˆ»ï¼Œä½†é€šå¸¸å¾ˆå¿«ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ç›®çš„&lt;/strong&gt;ï¼šå› ä¸º Propagate é˜¶æ®µæ˜¯å¹¶å‘çš„ï¼Œä¸šåŠ¡ä»£ç å¯èƒ½åœ¨æ­¤æœŸé—´ä¿®æ”¹äº†å¼•ç”¨ï¼ˆæ¯”å¦‚æŠŠä¸€ä¸ªç™½è‰²å¯¹è±¡èµ‹å€¼ç»™äº†ä¸€ä¸ªå·²ç»é»‘è‰²çš„ Tableï¼‰ã€‚å¦‚æœä¸ä¿®æ­£ï¼Œé‚£ä¸ªç™½è‰²å¯¹è±¡ä¼šè¢«è¯¯åˆ ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ“ä½œ&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;é‡æ–°éå†â€œç°åå•â€ï¼ˆGrayAgainï¼Œç”±å†™å±éšœäº§ç”Ÿï¼Œè¯¦è§ä¸‹æ–‡ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;æ‰«æå¼±å¼•ç”¨è¡¨ï¼ˆWeak Tablesï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;å®Œæˆæ‰€æœ‰å‰©ä½™çš„æ ‡è®°å·¥ä½œã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="-gcssweepstring-å­—ç¬¦ä¸²æ¸…ç†"&gt;â‘£ GCSsweepstring (å­—ç¬¦ä¸²æ¸…ç†)
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ç‰¹ç‚¹&lt;/strong&gt;ï¼šLua çš„çŸ­å­—ç¬¦ä¸²æ˜¯å•ç‹¬ç®¡ç†çš„ï¼ˆé€šå¸¸å­˜å‚¨åœ¨å…¨å±€å“ˆå¸Œè¡¨ä¸­ï¼‰ã€‚å› ä¸ºå­—ç¬¦ä¸²æ²¡æœ‰å­å¼•ç”¨ï¼Œæ¸…ç†éå¸¸å¿«ï¼Œç›´æ¥ä»å“ˆå¸Œè¡¨ä¸­ç§»é™¤æœªæ ‡è®°çš„å­—ç¬¦ä¸²ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="-gcssweep-æ™®é€šå¯¹è±¡æ¸…ç†"&gt;â‘¤ GCSsweep (æ™®é€šå¯¹è±¡æ¸…ç†)
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ“ä½œ&lt;/strong&gt;ï¼šéå†æ‰€æœ‰ GCObject é“¾è¡¨ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæ˜¯&lt;strong&gt;é»‘è‰²&lt;/strong&gt;ï¼šè¯´æ˜æ´»ç€ï¼Œé‡ç½®ä¸ºå½“å‰ç™½è‰²ï¼ˆä¸ºä¸‹ä¸€è½®åšå‡†å¤‡ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœæ˜¯&lt;strong&gt;æ—§ç™½è‰²&lt;/strong&gt;ï¼šè¯´æ˜æ­»äº†ï¼Œ&lt;strong&gt;free&lt;/strong&gt; æ‰å†…å­˜ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="-gcsfinalize-ç»ˆç»“"&gt;â‘¥ GCSfinalize (ç»ˆç»“)
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;å¤„ç†æ‰€æœ‰å®ç°äº† &lt;code&gt;__gc&lt;/code&gt; å…ƒæ–¹æ³•çš„ Userdataã€‚è¿™äº›å¯¹è±¡ä¸ä¼šç«‹å³é‡Šæ”¾ï¼Œè€Œæ˜¯ä¼šè¢«æ”¾å…¥ä¸€ä¸ªå•ç‹¬çš„åˆ—è¡¨ï¼Œç­‰å¾…è™šæ‹Ÿæœºè°ƒç”¨å®ƒä»¬çš„ææ„å‡½æ•°ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="å¹¶å‘ä¸‹çš„é»‘æŒ‡å‘ç™½ä¸å†™å±éšœ"&gt;å¹¶å‘ä¸‹çš„â€œé»‘æŒ‡å‘ç™½â€ä¸å†™å±éšœ
&lt;/h2&gt;&lt;p&gt;åœ¨ &lt;code&gt;GCSpropagate&lt;/code&gt; é˜¶æ®µï¼ŒGC å’Œä¸šåŠ¡é€»è¾‘æ˜¯äº¤æ›¿è¿è¡Œçš„ã€‚è¿™å°±å¸¦æ¥äº†ä¸€ä¸ªä¸¥é‡çš„&lt;strong&gt;æ•°æ®ç«äº‰&lt;/strong&gt;é—®é¢˜ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é—®é¢˜åœºæ™¯&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;GC æ ‡è®°äº† Table A ä¸º&lt;strong&gt;é»‘è‰²&lt;/strong&gt;ï¼ˆè®¤ä¸º A å·²ç»æ‰«æå®Œäº†ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;ä¸šåŠ¡ä»£ç æ‰§è¡Œ &lt;code&gt;A.x = B&lt;/code&gt;ï¼Œå…¶ä¸­ B æ˜¯ä¸€ä¸ª&lt;strong&gt;ç™½è‰²&lt;/strong&gt;å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;å› ä¸º A å·²ç»æ˜¯é»‘è‰²ï¼ŒGC ä¸ä¼šå†æ‰«æå®ƒã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;åæœ&lt;/strong&gt;ï¼šB ä½œä¸ºä¸€ä¸ªè¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå´å› ä¸ºæ²¡è¢«æ‰«æåˆ°ï¼Œä¿æŒç™½è‰²ã€‚åœ¨æ¸…é™¤é˜¶æ®µï¼ŒB ä¼šè¢«å½“åƒåœ¾å›æ”¶ï¼Œå¯¼è‡´ &lt;code&gt;A.x&lt;/code&gt; å˜æˆäº†é‡æŒ‡é’ˆï¼&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="è§£å†³æ–¹æ¡ˆå†™å±éšœ-write-barrier"&gt;è§£å†³æ–¹æ¡ˆï¼šå†™å±éšœ (Write Barrier)
&lt;/h3&gt;&lt;p&gt;ä¸ºäº†ç»´æŠ¤**â€œé»‘è‰²å¯¹è±¡ä¸èƒ½æŒ‡å‘ç™½è‰²å¯¹è±¡â€**è¿™ä¸€ä¸å˜é‡ï¼ˆInvariantï¼‰ï¼ŒLua åœ¨æ¯æ¬¡ä¿®æ”¹å¼•ç”¨ï¼ˆtable set/assignmentï¼‰æ—¶ï¼Œä¼šè§¦å‘å†™å±éšœã€‚&lt;/p&gt;
&lt;p&gt;å†™å±éšœæœ‰ä¸¤ç§ä¸»è¦å½¢å¼ï¼š&lt;/p&gt;
&lt;h4 id="1-å‰è¿›å±éšœ-forward-barrier---æŠŠç™½è‰²æŸ“ç°"&gt;1. å‰è¿›å±éšœ (Forward Barrier) - &amp;ldquo;æŠŠç™½è‰²æŸ“ç°&amp;rdquo;
&lt;/h4&gt;&lt;p&gt;å¦‚æœä½ æŠŠç™½è‰²å¯¹è±¡ B èµ‹ç»™é»‘è‰²å¯¹è±¡ Aï¼Œå±éšœä¼šç«‹å³æŠŠ &lt;strong&gt;B æŸ“æˆç°è‰²&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ„ä¹‰&lt;/strong&gt;ï¼šæ—¢ç„¶ A å¼•ç”¨äº† Bï¼Œé‚£ B è‚¯å®šæ˜¯æœ‰ç”¨çš„ï¼Œèµ¶ç´§æŠŠ B æ‹‰è¿›å¾…æ‰«ææ¸…å•ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;åº”ç”¨&lt;/strong&gt;ï¼šé€šå¸¸ç”¨äºå°†æ–°å¯¹è±¡èµ‹å€¼ç»™è€å¯¹è±¡æ—¶ã€‚ç”¨äº Closure (Upvalues)ã€Userdata ç­‰ã€‚å› ä¸ºè¿™äº›å¯¹è±¡é€šå¸¸ä¸åƒ Table é‚£æ ·é¢‘ç¹ä¿®æ”¹å¼•ç”¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="2-åé€€å±éšœ-backward-barrier---æŠŠé»‘è‰²å›é€€å˜ç°"&gt;2. åé€€å±éšœ (Backward Barrier) - &amp;ldquo;æŠŠé»‘è‰²å›é€€å˜ç°&amp;rdquo;
&lt;/h4&gt;&lt;p&gt;å¦‚æœä½ æŠŠç™½è‰²å¯¹è±¡ B èµ‹ç»™é»‘è‰²å¯¹è±¡ Aï¼Œå±éšœæŠŠ &lt;strong&gt;A å˜å›ç°è‰²&lt;/strong&gt;ï¼Œæ‰”è¿› &lt;code&gt;grayagain&lt;/code&gt; åˆ—è¡¨ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ„ä¹‰&lt;/strong&gt;ï¼šA ä½ è™½ç„¶æ‰«è¿‡äº†ï¼Œä½†ä½ ç°åœ¨åˆæœ‰äº†æ–°æ¬¢ï¼ŒGC ç¨åå¾—å›å¤´å†æŸ¥ä½ ä¸€æ¬¡ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;åº”ç”¨&lt;/strong&gt;ï¼šé€šå¸¸ç”¨äº &lt;code&gt;Table&lt;/code&gt; ç­‰å®¹å™¨ã€‚è¿™æ˜¯å› ä¸º Table å®¹æ˜“é¢‘ç¹å˜åŠ¨ï¼Œå¦‚æœç”¨å‰è¿›å±éšœï¼ˆæŠŠå­å¯¹è±¡å˜ç°ï¼‰ï¼Œä¸‹æ¬¡ Table å†å˜åŠ¨æ—¶åˆè¦è§¦å‘å±éšœï¼›è€ŒæŠŠ Table å˜ç°åï¼Œå®ƒå°±ç•™åœ¨ Gray é“¾è¡¨ä¸­ï¼Œä¹‹åå†å¾€é‡Œé¢å¡ç™½è‰²å¯¹è±¡å°±ä¸éœ€è¦è§¦å‘å±éšœäº†ï¼ˆå› ä¸ºçˆ¶å¯¹è±¡å·²ç»æ˜¯ç°çš„äº†ï¼‰ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="æºç çª¥æ¢"&gt;æºç çª¥æ¢
&lt;/h3&gt;&lt;p&gt;è®©æˆ‘ä»¬çœ‹çœ‹ Lua å†…éƒ¨å® &lt;code&gt;luaC_barrier&lt;/code&gt; çš„ç®€åŒ–é€»è¾‘ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/* ä¼ªä»£ç é€»è¾‘ï¼šå†™å±éšœ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;#define luaC_barrier(L, p, v) { \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; /* p æ˜¯çˆ¶å¯¹è±¡(Table)ï¼Œv æ˜¯å­å¯¹è±¡(Value) */ \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (isblack(p) &amp;amp;&amp;amp; iswhite(v)) { \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; /* è§¦å‘å±éšœï¼šé»‘è‰²æŒ‡å‘äº†ç™½è‰² */ \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; luaC_barrier_(L, obj2gco(p), obj2gco(v)); \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; } \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;void luaC_barrier_ (lua_State *L, GCObject *p, GCObject *v) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; /* ä¿æŒé»‘ç™½ä¸å˜æ€§ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (isdead(L, v)) return; // å·²ç»æ­»çš„ä¸ç®¡
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // ç­–ç•¥ï¼šé€šå¸¸æ˜¯å°† v (å­å¯¹è±¡) æ ‡ç° (Forward Barrier)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; // æˆ–è€…å°† p (çˆ¶å¯¹è±¡) æ”¾å…¥ grayagain åˆ—è¡¨ (Backward Barrier)
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; reallymarkobject(L, v);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;æ­£æ˜¯è¿™ä¸ª &lt;code&gt;luaC_barrier&lt;/code&gt;ï¼Œä¿è¯äº†å¢é‡ GC çš„æ­£ç¡®æ€§ã€‚å®ƒå°±åƒä¸€ä¸ªç›‘è§†å™¨ï¼Œæ‹¦æˆªäº†æ‰€æœ‰çš„èµ‹å€¼æ“ä½œã€‚&lt;/p&gt;
&lt;h2 id="gcè§¦å‘çš„æ—¶æœº"&gt;GCè§¦å‘çš„æ—¶æœº
&lt;/h2&gt;&lt;p&gt;å‡è®¾æˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;local i = 1234
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;è¿™è¡Œä»£ç ä¼šè§¦å‘ GC å—ï¼Ÿç­”æ¡ˆæ˜¯&lt;strong&gt;ä¸ä¼š&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;æ ¹æ® Lua çš„å†…å­˜æ¨¡å‹ï¼ˆå¦‚ä¸Šæ–‡ &lt;code&gt;TValue&lt;/code&gt; ç»“æ„æ‰€ç¤ºï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å€¼ç±»å‹ï¼ˆValue Typesï¼‰&lt;/strong&gt;ï¼šå¦‚ &lt;code&gt;nil&lt;/code&gt;, &lt;code&gt;boolean&lt;/code&gt;, &lt;code&gt;number&lt;/code&gt; (integer/float)ã€‚è¿™äº›æ•°æ®ç›´æ¥å­˜æ”¾åœ¨ Lua æ ˆçš„ &lt;code&gt;TValue&lt;/code&gt; ç»“æ„ä½“ä¸­ã€‚å®ƒä»¬éšç€æ ˆå¸§çš„é”€æ¯è€Œè‡ªåŠ¨æ¶ˆå¤±ï¼Œ&lt;strong&gt;ä¸æ¶‰åŠå †å†…å­˜åˆ†é…&lt;/strong&gt;ï¼ˆmallocï¼‰ï¼Œå› æ­¤ä¸è®¡å…¥ GC çš„å€ºåŠ¡ï¼ˆGCdebtï¼‰ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šè§¦å‘ GC æ­¥è¿›ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¼•ç”¨ç±»å‹ï¼ˆReference Typesï¼‰&lt;/strong&gt;ï¼šå¦‚ &lt;code&gt;table&lt;/code&gt;, &lt;code&gt;function&lt;/code&gt;, &lt;code&gt;string&lt;/code&gt; (é•¿å­—ç¬¦ä¸²), &lt;code&gt;userdata&lt;/code&gt;ã€‚è¿™äº›å¯¹è±¡å­˜æ´»åœ¨å †ä¸Šï¼Œæ‰æ˜¯ GC ä¸»è¦â€œè¿½æ€â€çš„ç›®æ ‡ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨ Lua è™šæ‹Ÿæœºæºç ä¸­ï¼Œå‡ ä¹æ‰€æœ‰æ¶‰åŠå†…å­˜åˆ†é…çš„æ“ä½œï¼ˆå¦‚ &lt;code&gt;lua_newtable&lt;/code&gt;, &lt;code&gt;lua_pushstring&lt;/code&gt;ï¼‰ä¹‹åï¼Œéƒ½ä¼šè°ƒç”¨ä¸€ä¸ªæ£€æŸ¥å®ï¼š&lt;strong&gt;&lt;code&gt;luaC_checkGC&lt;/code&gt;&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;#define luaC_checkGC(L) { \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (G(L)-&amp;gt;GCdebt &amp;gt; 0) { \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; luaC_step(L); \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; } \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; condchangemem(L,pre,pos); \
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;GCdebt&lt;/code&gt; (GC å€ºåŠ¡)&lt;/strong&gt;ï¼šè¿™æ˜¯ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚æ¯å½“ä½ åˆ†é… 1 å­—èŠ‚å†…å­˜ï¼Œ&lt;code&gt;GCdebt&lt;/code&gt; å°±ä¼šå¢åŠ  1ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;åˆ¤æ–­é€»è¾‘&lt;/strong&gt;ï¼šåªè¦â€œå€ºåŠ¡â€å¤§äº 0ï¼ŒLua å°±ä¼šè®¤ä¸ºâ€œå¦‚æœä½ åˆ¶é€ äº†åƒåœ¾ï¼ˆæˆ–è€…ç”³è¯·äº†æ–°å†…å­˜ï¼‰ï¼Œä½ å°±å¾—è´Ÿè´£æ¸…ç†ä¸€ç‚¹åƒåœ¾â€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;luaC_step&lt;/code&gt;&lt;/strong&gt;ï¼šè¿™å°±æ˜¯æ‰§è¡Œä¸€æ¬¡ GCâ€œæ­¥è¿›â€çš„å‡½æ•°ã€‚å®ƒä¸ä¼šè·‘å®Œæ•´ä¸ª GC æµç¨‹ï¼Œè€Œæ˜¯åªè·‘ä¸€å°æ­¥ï¼ˆå…·ä½“è·‘å¤šè¿œï¼Œç”± &lt;code&gt;stepmul&lt;/code&gt; å†³å®šï¼‰ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="æ§åˆ¶-gc-çš„é€Ÿç‡"&gt;æ§åˆ¶ GC çš„é€Ÿç‡
&lt;/h2&gt;&lt;p&gt;äº†è§£äº†åŸç†ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹æ‡‚ &lt;code&gt;collectgarbage&lt;/code&gt; çš„ä¸¤ä¸ªå‚æ•°äº†ï¼š&lt;/p&gt;
&lt;h3 id="pause-æš‚åœç³»æ•°"&gt;&lt;code&gt;pause&lt;/code&gt; (æš‚åœç³»æ•°)
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å«ä¹‰&lt;/strong&gt;ï¼šGCçš„é—´æ­‡ç‡, å°† GCdebt è®¾ç½®ä¸ºä¸€ä¸ªå·¨å¤§çš„è´Ÿæ•°æ¥å®ç°çš„, é»˜è®¤å€¼200ï¼ˆå³ 200%ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é€»è¾‘&lt;/strong&gt;ï¼šå¦‚æœå½“å‰å†…å­˜æ˜¯ 10MBï¼ŒGC ç»“æŸåå›æ”¶åˆ° 5MBã€‚é‚£ä¹ˆä¸‹ä¸€æ¬¡ GC å¯åŠ¨çš„é˜ˆå€¼æ˜¯ &lt;code&gt;5MB * 200% = 10MB&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å€¼è¶Šå°ï¼ŒGC è¶Šå‹¤å¿«ï¼Œå†…å­˜å ç”¨è¶Šä½ï¼Œä½† CPU æ¶ˆè€—è¶Šé«˜ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;static void setpause (global_State *g) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; l_mem threshold, debt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; l_mem estimate = g-&amp;gt;GCestimate / 100; // è·å–ä¼°ç®—å†…å­˜
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; l_mem pause = (g-&amp;gt;gcpause != 0) ? g-&amp;gt;gcpause : 200; // é»˜è®¤ 200
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; /* è®¡ç®—æˆ‘ä»¬è¦ç­‰å¾…å¤šå°‘å†…å­˜åˆ†é… */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; threshold = (pause * estimate);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; /* è®¾ç½®å€ºåŠ¡ = ä¼°ç®—å€¼ - é˜ˆå€¼
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; å› ä¸º é˜ˆå€¼ é€šå¸¸ &amp;gt; ä¼°ç®—å€¼ï¼Œæ‰€ä»¥è¿™é‡Œ debt æ˜¯è´Ÿæ•°
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; debt = gettotalbytes(g) - threshold;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; luaE_setdebt(g, debt);
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id="stepmul-æ­¥è¿›å€ç‡"&gt;&lt;code&gt;stepmul&lt;/code&gt; (æ­¥è¿›å€ç‡)
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å«ä¹‰&lt;/strong&gt;ï¼šæ§åˆ¶ GC æ‰«æçš„é€Ÿåº¦ã€‚é»˜è®¤å€¼ 200(200%)ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é€»è¾‘&lt;/strong&gt;ï¼šåˆ†é…äº† 1 å­—èŠ‚å†…å­˜ï¼ˆå¢åŠ äº† 1 å­—èŠ‚å€ºåŠ¡ï¼‰,GC éœ€è¦æ‰§è¡Œç­‰åŒäº 2 å­—èŠ‚å†…å­˜çš„å·¥ä½œé‡ï¼Œæ‰èƒ½æŠŠè¿™ 1 å­—èŠ‚çš„å€ºåŠ¡â€œæŠµæ¶ˆâ€æ‰ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœä½ å‘ç°å†…å­˜é£™å‡å¾—æ¯” GC å›æ”¶å¾—å¿«ï¼ˆAlloc &amp;gt; Freeï¼‰ï¼Œè¯´æ˜ GC è·‘æ…¢äº†ï¼Œéœ€è¦&lt;strong&gt;è°ƒå¤§&lt;/strong&gt; &lt;code&gt;stepmul&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å¦‚æœä½ å‘ç°æ¸¸æˆæ˜æ˜¾å¡é¡¿ï¼Œå¯èƒ½æ˜¯ GC ä¸€æ¬¡æ­¥è¿›å ç”¨ CPU å¤ªå¤šï¼Œå°è¯•&lt;strong&gt;è°ƒå°&lt;/strong&gt; &lt;code&gt;stepmul&lt;/code&gt; è®©åˆ‡ç‰‡æ›´ç»†ã€‚&lt;/li&gt;
&lt;/ul&gt;</description></item><item><title>Lua Table</title><link>https://WeissGoat.github.io/WBlog/p/lua-table/</link><pubDate>Mon, 05 Feb 2024 18:00:00 +0800</pubDate><guid>https://WeissGoat.github.io/WBlog/p/lua-table/</guid><description>&lt;h1 id="lua-table-æºç å‰–ææ··åˆæ•°æ®ç»“æ„çš„è‰ºæœ¯"&gt;Lua Table æºç å‰–æï¼šæ··åˆæ•°æ®ç»“æ„çš„è‰ºæœ¯
&lt;/h1&gt;&lt;p&gt;åœ¨ Lua çš„è®¾è®¡å“²å­¦ä¸­ï¼ŒTable æ˜¯å”¯ä¸€çš„å¤åˆæ•°æ®ç»“æ„ã€‚å®ƒæ—¢è¦æ‰®æ¼”æ•°ç»„ï¼ˆArrayï¼‰çš„è§’è‰²ï¼Œåˆè¦èƒœä»»å“ˆå¸Œè¡¨ï¼ˆHash Mapï¼‰çš„å·¥ä½œã€‚è¿™ç§â€œä¸‡é‡‘æ²¹â€çš„ç‰¹æ€§èƒŒåï¼Œéšè—ç€éå¸¸ç²¾å¦™çš„è®¾è®¡æ€è·¯ã€‚&lt;/p&gt;
&lt;p&gt;æœ€è¿‘åœ¨ç ”ç©¶ Lua æºç ï¼ˆåŸºäº Lua 5.3/5.4 é€»è¾‘ï¼‰ï¼Œæ•´ç†äº†ä¸€äº›å…³äº Table å†…éƒ¨å®ç°çš„ç¬”è®°ï¼Œåœ¨æ­¤è®°å½•å¹¶åˆ†äº«ä¸€ä¸‹å…³äºå…¶æ•°æ®ç»“æ„ã€å†…å­˜å¸ƒå±€ã€å†²çªè§£å†³ä»¥åŠ Rehash æœºåˆ¶çš„æ¢ç´¢ã€‚&lt;/p&gt;
&lt;h2 id="1-æ ¸å¿ƒæ•°æ®ç»“æ„æ··åˆå­˜å‚¨çš„åŸºçŸ³"&gt;1. æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šæ··åˆå­˜å‚¨çš„åŸºçŸ³
&lt;/h2&gt;&lt;p&gt;Lua Table çš„é«˜æ•ˆç”±å…¶åº•å±‚çš„ &lt;code&gt;struct Table&lt;/code&gt; å†³å®šã€‚ä»æºç ä¸­æˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œå®ƒå¹¶éå•çº¯çš„å“ˆå¸Œè¡¨ï¼Œè€Œæ˜¯&lt;strong&gt;æ•°ç»„&lt;/strong&gt;ä¸&lt;strong&gt;å“ˆå¸Œè¡¨&lt;/strong&gt;çš„ç»“åˆä½“ã€‚&lt;/p&gt;
&lt;h3 id="11-table-ç»“æ„ä½“å®šä¹‰"&gt;1.1 Table ç»“æ„ä½“å®šä¹‰
&lt;/h3&gt;&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;typedef struct Table {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; CommonHeader;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; lu_byte flags; /* 1&amp;lt;&amp;lt;p means tagmethod(p) is not present (å…ƒæ–¹æ³•ç¼“å­˜) */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; lu_byte lsizenode; /* å“ˆå¸Œè¡¨é•¿åº¦çš„å¯¹æ•°ï¼Œå³ hash_size = 2^lsizenode */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; unsigned int alimit;/* æ•°ç»„éƒ¨åˆ†çš„â€œé€»è¾‘â€å¤§å° (å³ sizearray) */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TValue *array; /* æ•°ç»„éƒ¨åˆ†æŒ‡é’ˆ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Node *node; /* å“ˆå¸Œæ¡¶æ•°ç»„èµ·å§‹æŒ‡é’ˆ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; Node *lastfree; /* æŒ‡å‘å“ˆå¸Œéƒ¨åˆ†æœ€åä¸€ä¸ªç©ºé—²ä½ç½®ï¼Œç”¨äºå¿«é€Ÿæ’å…¥ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; struct Table *metatable; /* å…ƒè¡¨ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; GCObject *gclist;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;} Table;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;strong&gt;è®¾è®¡è§£è¯»ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;åŒé‡å­˜å‚¨&lt;/strong&gt;ï¼š&lt;code&gt;array&lt;/code&gt; æŒ‡é’ˆç®¡ç†è¿ç»­å†…å­˜ï¼Œç”¨äºå­˜æ”¾æ•´æ•°é”®ï¼ˆ1..nï¼‰ï¼›&lt;code&gt;node&lt;/code&gt; æŒ‡é’ˆç®¡ç†å“ˆå¸Œæ¡¶ï¼Œç”¨äºå­˜æ”¾å…¶ä»–é”®æˆ–ç¦»æ•£çš„æ•´æ•°é”®ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç©ºé—´æ¢æ—¶é—´&lt;/strong&gt;ï¼š&lt;code&gt;lastfree&lt;/code&gt; æŒ‡é’ˆçš„è®¾è®¡éå¸¸å·§å¦™ï¼Œå®ƒé¿å…äº†æ¯æ¬¡æ’å…¥æ—¶çº¿æ€§æ‰«æå¯»æ‰¾ç©ºä½ï¼Œå°†æŸ¥æ‰¾ç©ºé—²ä½ç½®çš„å¤æ‚åº¦å°½é‡é™ä½ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;lsizenode&lt;/strong&gt;ï¼šå“ˆå¸Œè¡¨çš„å¤§å°å§‹ç»ˆä¿æŒä¸º 2 çš„å¹‚æ¬¡ï¼Œè¿™é‡Œå­˜å‚¨çš„æ˜¯å¹‚æ¬¡ï¼ˆlog2ï¼‰ï¼Œçœå»äº†å­˜å‚¨å®é™…å¤§å°çš„å†…å­˜ï¼Œè®¡ç®—æ—¶ä½ç§»å³å¯ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="12-èŠ‚ç‚¹nodeä¸é”®key"&gt;1.2 èŠ‚ç‚¹ï¼ˆNodeï¼‰ä¸é”®ï¼ˆKeyï¼‰
&lt;/h3&gt;&lt;p&gt;å“ˆå¸Œéƒ¨åˆ†çš„èŠ‚ç‚¹ç»“æ„å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;typedef union TKey {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; struct {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TValuefields;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; struct Node *next; /* é“¾è¡¨æ³•è§£å†³å†²çªï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªå†²çªèŠ‚ç‚¹ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; } nk;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TValue tvk;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;} TKey;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;typedef struct Node {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TValue i_val;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TKey i_key;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;} Node;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;è¿™é‡Œ &lt;code&gt;Node&lt;/code&gt; åŒ…å«äº† Key å’Œ Valueã€‚Key æ˜¯ä¸€ä¸ª unionï¼Œä¸ºäº†å†…å­˜å¯¹é½å’Œè®¿é—®æ•ˆç‡ï¼Œå½“å‘ç”Ÿå“ˆå¸Œå†²çªæ—¶ï¼Œé€šè¿‡ &lt;code&gt;next&lt;/code&gt; æŒ‡é’ˆå½¢æˆå•å‘é“¾è¡¨ã€‚&lt;/p&gt;
&lt;h2 id="2-é”®çš„å½’å±æ•°ç»„è¿˜æ˜¯å“ˆå¸Œ"&gt;2. é”®çš„å½’å±ï¼šæ•°ç»„è¿˜æ˜¯å“ˆå¸Œï¼Ÿ
&lt;/h2&gt;&lt;p&gt;å½“æˆ‘ä»¬æ‰§è¡Œ &lt;code&gt;t[k] = v&lt;/code&gt; æ—¶ï¼ŒLua æ˜¯å¦‚ä½•å†³å®šæŠŠæ•°æ®å­˜åœ¨ &lt;code&gt;array&lt;/code&gt; è¿˜æ˜¯ &lt;code&gt;node&lt;/code&gt; é‡Œçš„ï¼Ÿ&lt;/p&gt;
&lt;h3 id="21-æ•´æ•°é”®çš„vip-é€šé“"&gt;2.1 æ•´æ•°é”®çš„â€œVIP é€šé“â€
&lt;/h3&gt;&lt;p&gt;ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ­£æ•´æ•°é”®ï¼ˆå¦‚ &lt;code&gt;t[1]&lt;/code&gt;, &lt;code&gt;t[100]&lt;/code&gt;ï¼‰ä¼šä¼˜å…ˆå°è¯•æ”¾å…¥æ•°ç»„éƒ¨åˆ†ã€‚ä½†å¹¶éæ‰€æœ‰æ•´æ•°éƒ½ä¼šè¿›å…¥æ•°ç»„ï¼Œå¿…é¡»æ»¡è¶³&lt;strong&gt;åˆ©ç”¨ç‡åŸåˆ™&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒè§„åˆ™&lt;/strong&gt;ï¼šåŒ…å«å½“å‰ key çš„åŒºé—´ $[1, 2^n]$ å†…ï¼Œéç©ºå…ƒç´ æ•°é‡å¿…é¡»å¤§äº $2^{n-1}$ï¼ˆå³åˆ©ç”¨ç‡ &amp;gt; 50%ï¼‰ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;æºç ä½è¯ (&lt;code&gt;ltable.c&lt;/code&gt;)&lt;/strong&gt;ï¼š Lua é€šè¿‡ &lt;code&gt;computesizes&lt;/code&gt; å‡½æ•°æ¥è®¡ç®—æ•°ç»„çš„æœ€ä½³å¤§å°ï¼Œä»£ç æ¸…æ™°åœ°å±•ç¤ºäº†â€œ&amp;gt; 50%â€çš„åˆ¤æ–­é€»è¾‘ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/* è®¡ç®—æ•°ç»„éƒ¨åˆ†çš„æœ€ä½³å¤§å° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;static unsigned int computesizes (unsigned int nums[], unsigned int *narray) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; int i;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; unsigned int twotoi; /* 2^i */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; unsigned int a = 0; /* ç»Ÿè®¡å°äº 2^i çš„å…ƒç´ ä¸ªæ•° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; unsigned int na = 0; /* æœ€ç»ˆè½å…¥æ•°ç»„éƒ¨åˆ†çš„å…ƒç´ ä¸ªæ•° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; unsigned int optimal = 0; /* æœ€ä½³æ•°ç»„å¤§å° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; /* å¾ªç¯éå†æ¯ä¸ª 2^i åŒºé—´ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; for (i = 0, twotoi = 1; twotoi/2 &amp;lt; *narray; i++, twotoi *= 2) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (nums[i] &amp;gt; 0) {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; a += nums[i];
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; if (a &amp;gt; twotoi/2) { /* æ ¸å¿ƒåˆ¤æ–­ï¼šåˆ©ç”¨ç‡ &amp;gt; 50% */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; optimal = twotoi;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; na = a;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; *narray = optimal;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; return na;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;strong&gt;ä¸¾ä¸ªä¾‹å­&lt;/strong&gt;ï¼š å¦‚æœä½ åˆ›å»ºäº†ä¸€ä¸ªè¡¨ &lt;code&gt;t = {[1]=1, [1000]=1}&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;1&lt;/code&gt; åœ¨æ•°ç»„éƒ¨åˆ†ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;1000&lt;/code&gt; è™½ç„¶æ˜¯æ•´æ•°ï¼Œä½†å¦‚æœå¼ºè¡Œæ‰©å®¹æ•°ç»„åˆ° 1000ï¼Œä¸­é—´ä¼šæœ‰ 998 ä¸ªç©ºæ´ï¼Œä¸æ»¡è¶³ &lt;code&gt;a &amp;gt; twotoi/2&lt;/code&gt;ã€‚å› æ­¤ï¼Œ&lt;code&gt;1000&lt;/code&gt; ä¼šè¢«å½“ä½œæ™®é€š Key æ‰”è¿›å“ˆå¸Œéƒ¨åˆ†ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="22-å“ˆå¸Œéƒ¨åˆ†çš„æ”¶å®¹æ‰€"&gt;2.2 å“ˆå¸Œéƒ¨åˆ†çš„â€œæ”¶å®¹æ‰€â€
&lt;/h3&gt;&lt;p&gt;ä»¥ä¸‹æƒ…å†µ Key ä¼šè¿›å…¥å“ˆå¸Œè¡¨ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;éæ•´æ•°ç±»å‹&lt;/strong&gt;ï¼šå­—ç¬¦ä¸²ã€Tableã€Userdata ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è¶Šç•Œçš„æ•´æ•°&lt;/strong&gt;ï¼šæ•°å€¼æå¤§ï¼Œæˆ–è€…åƒä¸Šé¢æåˆ°çš„è¿‡äºç¨€ç–çš„æ•´æ•°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è´Ÿæ•°&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="3-å†²çªè§£å†³brents-method-çš„å˜ç§"&gt;3. å†²çªè§£å†³ï¼šBrent&amp;rsquo;s Method çš„å˜ç§
&lt;/h2&gt;&lt;p&gt;è¿™æ˜¯ Lua Table å®ç°ä¸­æœ€â€œéªšâ€çš„æ“ä½œä¹‹ä¸€ã€‚&lt;/p&gt;
&lt;p&gt;é€šå¸¸å“ˆå¸Œè¡¨è§£å†³å†²çªç”¨çš„æ˜¯&lt;strong&gt;å¼€é“¾æ³•ï¼ˆOpen Addressing with Chainingï¼‰&lt;/strong&gt;ï¼Œä½† Lua ä¸ºäº†èŠ‚çœå†…å­˜ï¼Œå¹¶æ²¡æœ‰åœ¨è¿™ä¸ªé“¾è¡¨ä¹‹å¤–å•ç‹¬åˆ†é…å†…å­˜ï¼Œè€Œæ˜¯ç›´æ¥åˆ©ç”¨å“ˆå¸Œæ¡¶æ•°ç»„ä¸­æœªè¢«ä½¿ç”¨çš„æ§½ä½ã€‚&lt;/p&gt;
&lt;h3 id="31-æ’å…¥é€»è¾‘insert"&gt;3.1 æ’å…¥é€»è¾‘ï¼ˆInsertï¼‰
&lt;/h3&gt;&lt;p&gt;å½“æˆ‘ä»¬è¦æ’å…¥ä¸€ä¸ªæ–°çš„ Key (&lt;code&gt;new_key&lt;/code&gt;)ï¼Œç®—å‡ºå®ƒåº”è¯¥åœ¨çš„ä½ç½® &lt;code&gt;main_pos&lt;/code&gt;ï¼Œå´å‘ç°é‚£é‡Œå·²ç»æœ‰â€œäººâ€äº† (&lt;code&gt;old_node&lt;/code&gt;)ï¼ŒLua ä¼šæ ¹æ® &lt;code&gt;old_node&lt;/code&gt; çš„èº«ä»½é‡‡å–ä¸åŒç­–ç•¥ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æºç ä½è¯ (&lt;code&gt;luaH_newkey&lt;/code&gt;)&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;span class="lnt"&gt;21
&lt;/span&gt;&lt;span class="lnt"&gt;22
&lt;/span&gt;&lt;span class="lnt"&gt;23
&lt;/span&gt;&lt;span class="lnt"&gt;24
&lt;/span&gt;&lt;span class="lnt"&gt;25
&lt;/span&gt;&lt;span class="lnt"&gt;26
&lt;/span&gt;&lt;span class="lnt"&gt;27
&lt;/span&gt;&lt;span class="lnt"&gt;28
&lt;/span&gt;&lt;span class="lnt"&gt;29
&lt;/span&gt;&lt;span class="lnt"&gt;30
&lt;/span&gt;&lt;span class="lnt"&gt;31
&lt;/span&gt;&lt;span class="lnt"&gt;32
&lt;/span&gt;&lt;span class="lnt"&gt;33
&lt;/span&gt;&lt;span class="lnt"&gt;34
&lt;/span&gt;&lt;span class="lnt"&gt;35
&lt;/span&gt;&lt;span class="lnt"&gt;36
&lt;/span&gt;&lt;span class="lnt"&gt;37
&lt;/span&gt;&lt;span class="lnt"&gt;38
&lt;/span&gt;&lt;span class="lnt"&gt;39
&lt;/span&gt;&lt;span class="lnt"&gt;40
&lt;/span&gt;&lt;span class="lnt"&gt;41
&lt;/span&gt;&lt;span class="lnt"&gt;42
&lt;/span&gt;&lt;span class="lnt"&gt;43
&lt;/span&gt;&lt;span class="lnt"&gt;44
&lt;/span&gt;&lt;span class="lnt"&gt;45
&lt;/span&gt;&lt;span class="lnt"&gt;46
&lt;/span&gt;&lt;span class="lnt"&gt;47
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;æ’å…¥æ–°é”®çš„æ ¸å¿ƒé€»è¾‘&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="err"&gt;ç®€åŒ–ç‰ˆ&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="n"&gt;TValue&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;luaH_newkey&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lua_State&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;L&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Table&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;TValue&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ttisnil&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="n"&gt;luaG_runerror&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;L&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;&amp;#34;table index is nil&amp;#34;&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="mf"&gt;1.&lt;/span&gt; &lt;span class="err"&gt;è®¡ç®—ä¸»ä½ç½®&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Main&lt;/span&gt; &lt;span class="n"&gt;Position&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mainposition&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="mf"&gt;2.&lt;/span&gt; &lt;span class="err"&gt;å¦‚æœä¸»ä½ç½®å·²è¢«å ç”¨&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;ttisnil&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gval&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;||&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;dummynode&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;othern&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;è·å–ç©ºé—²ä½ç½®&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lastfree&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;getfreepos&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;æ²¡ä½ç½®äº†ï¼Ÿæ‰©å®¹&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;rehash&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;L&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;luaH_set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;L&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;è®¡ç®—å ä½è€…&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;old_node&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;åŸæœ¬è¯¥åœ¨çš„ä¸»ä½ç½®&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;othern&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mainposition&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;keyfromval&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;othern&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="n"&gt;Case&lt;/span&gt; &lt;span class="n"&gt;A&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="err"&gt;é¸ å é¹Šå·¢&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="err"&gt;æŠŠ&lt;/span&gt; &lt;span class="n"&gt;old_node&lt;/span&gt; &lt;span class="err"&gt;èµ¶åˆ°&lt;/span&gt; &lt;span class="n"&gt;free&lt;/span&gt; &lt;span class="n"&gt;pos&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;othern&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;othern&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;othern&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;othern&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;æ‰¾åˆ°æŒ‡å‘&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="err"&gt;çš„å‰é©±&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;othern&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cast_int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;othern&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;ä¿®æ­£é“¾è¡¨æŒ‡å‘æ–°ä½ç½®&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;æ¬è¿æ•°æ®&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;è…¾å‡º&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="err"&gt;ç»™æ–°é”®ï¼Œå› ä¸º&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="err"&gt;æ˜¯æ–°é”®çš„ä¸»ä½ç½®&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;setnilvalue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gval&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="n"&gt;Case&lt;/span&gt; &lt;span class="n"&gt;B&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="err"&gt;åŸä½æ°‘å†²çª&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="err"&gt;æ–°é”®åªèƒ½å»&lt;/span&gt; &lt;span class="n"&gt;free&lt;/span&gt; &lt;span class="n"&gt;pos&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;!=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cast_int&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;å¤´æ’æ³•ï¼šé“¾åœ¨&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="err"&gt;åé¢&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;cast_int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;mp&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;setnodekey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;L&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;i_key&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;gval&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mp&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æƒ…å†µ Aï¼šé¸ å é¹Šå·¢&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;å¦‚æœ &lt;code&gt;old_node&lt;/code&gt; æ˜¯è¢«æŒ¤åˆ°è¿™é‡Œçš„ï¼ˆå³ &lt;code&gt;othern != mp&lt;/code&gt;ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ“ä½œ&lt;/strong&gt;ï¼šLua æŠŠå®ƒæŒªåˆ° &lt;code&gt;lastfree&lt;/code&gt;ï¼ŒæŠŠ &lt;code&gt;main_pos&lt;/code&gt; æŠ¢å›æ¥ç»™ &lt;code&gt;new_key&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç›®çš„&lt;/strong&gt;ï¼šä¿è¯ &lt;code&gt;new_key&lt;/code&gt; è¿™ç§â€œåŸä½æ°‘â€èƒ½ç›´æ¥æ‰¾åˆ°ä½ç½®ï¼Œå‡å°‘åç»­æŸ¥æ‰¾çš„å¼€é”€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æƒ…å†µ Bï¼šåŸä½æ°‘å†²çª&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;å¦‚æœ &lt;code&gt;old_node&lt;/code&gt; æœ¬æ¥å°±è¯¥å¾…åœ¨è¿™é‡Œã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ“ä½œ&lt;/strong&gt;ï¼š&lt;code&gt;new_key&lt;/code&gt; å» &lt;code&gt;lastfree&lt;/code&gt;ï¼Œå¹¶é“¾æ¥åœ¨ &lt;code&gt;old_node&lt;/code&gt; åé¢ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™ç§æœºåˆ¶è¢«ç§°ä¸º &lt;strong&gt;Chained Scatter Table&lt;/strong&gt;ï¼Œå®ƒå……åˆ†åˆ©ç”¨äº†æ•°ç»„ç©ºé—´ï¼Œé¿å…äº†ç”±äºå¤§é‡å¾®å°å¯¹è±¡åˆ†é…å¯¼è‡´çš„å†…å­˜ç¢ç‰‡ã€‚&lt;/p&gt;
&lt;h2 id="4-åŠ¨æ€æ‰©å®¹rehash-çš„è‰ºæœ¯"&gt;4. åŠ¨æ€æ‰©å®¹ï¼šRehash çš„è‰ºæœ¯
&lt;/h2&gt;&lt;p&gt;Table çš„ç©ºé—´ä¸æ˜¯å›ºå®šçš„ã€‚å½“ç©ºé—´ä¸è¶³æˆ–åˆ©ç”¨ç‡å¤±è¡¡æ—¶ï¼Œä¼šè§¦å‘ Rehashã€‚&lt;/p&gt;
&lt;h3 id="41-è§¦å‘æ—¶æœº"&gt;4.1 è§¦å‘æ—¶æœº
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ’å…¥æ–°é”®ä¸”ç©ºé—´å·²æ»¡&lt;/strong&gt;ï¼šå½“æˆ‘ä»¬èµ‹å€¼ä¸€ä¸ªæ–°é”®ï¼Œè€Œ Table æ—¢æ²¡æœ‰æ•°ç»„ç©ºé—´ï¼Œä¹Ÿæ²¡æœ‰å“ˆå¸Œç©ºä½æ—¶ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ³¨æ„&lt;/strong&gt;ï¼šå°†æŸä¸ª Key ç½®ä¸º &lt;code&gt;nil&lt;/code&gt; &lt;strong&gt;ä¸ä¼š&lt;/strong&gt;ç«‹å³è§¦å‘ Rehashï¼ˆä¸ºäº†é˜²æ­¢é¢‘ç¹çš„å†…å­˜æŠ–åŠ¨ï¼‰ã€‚åªæœ‰åœ¨ç©ºé—´ä¸è¶³éœ€è¦é‡æ–°è¯„ä¼°æ—¶ï¼Œæ‰ä¼šå›æ”¶ &lt;code&gt;nil&lt;/code&gt; å ç”¨çš„ç©ºé—´ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="42-rehash-çš„ä¸‰éƒ¨æ›²"&gt;4.2 Rehash çš„ä¸‰éƒ¨æ›²
&lt;/h3&gt;&lt;p&gt;Rehash æ˜¯ä¸€ä¸ªç›¸å¯¹æ˜‚è´µçš„æ“ä½œï¼ŒLua å¿…é¡»ä¸€æ¬¡æ€§é‡æ–°è®¡ç®—æ•°ç»„å’Œå“ˆå¸Œä¸¤éƒ¨åˆ†çš„æœ€ä½³å¤§å°ã€‚&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;ç»Ÿè®¡ï¼ˆCountingï¼‰&lt;/strong&gt;ï¼š éå†æ•´ä¸ª Tableï¼ˆåŒ…æ‹¬ç°æœ‰çš„ Array å’Œ Hash éƒ¨åˆ†ï¼‰ï¼Œç»Ÿè®¡æ‰€æœ‰æ­£æ•´æ•°é”®çš„æ•°é‡ï¼Œå¹¶æŒ‰ $2^n$ çš„åŒºé—´ï¼ˆ1-2, 3-4, 5-8&amp;hellip;ï¼‰è¿›è¡Œåˆ†æ¡¶ç»Ÿè®¡ã€‚åŒæ—¶ç»Ÿè®¡éæ•´æ•°é”®çš„æ€»æ•°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å®šç•Œï¼ˆSizingï¼‰&lt;/strong&gt;ï¼š è®¡ç®—æ•°ç»„éƒ¨åˆ†çš„æœ€ä½³å¤§å° &lt;code&gt;sizearray&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;ç®—æ³•ï¼šæ‰¾åˆ°æœ€å¤§çš„ $N$ï¼ˆ$2$ çš„å¹‚ï¼‰ï¼Œä½¿å¾— $[1, N]$ åŒºé—´å†…çš„æ•´æ•°é”®æ•°é‡ $\ge N/2$ã€‚&lt;/li&gt;
&lt;li&gt;å‡¡æ˜¯å°äºç­‰äº $N$ çš„æ•´æ•°æ”¾å…¥æ–°æ•°ç»„ï¼Œå…¶ä½™æ”¾å…¥æ–°å“ˆå¸Œè¡¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="3"&gt;
&lt;li&gt;&lt;strong&gt;æ¬è¿ï¼ˆRelocationï¼‰&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;ç”³è¯·æ–°çš„ Array å’Œ Hash å†…å­˜å—ã€‚&lt;/li&gt;
&lt;li&gt;å°†æ•°æ®æ¬è¿è¿‡å»ï¼ˆé‡æ–°è®¡ç®—å“ˆå¸Œå€¼ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;é‡Šæ”¾æ—§å†…å­˜ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆ Lua Table æ—¢èƒ½åƒ C æ•°ç»„ä¸€æ ·ç´§å‡‘é«˜æ•ˆï¼Œåˆèƒ½åƒ Python Dict ä¸€æ ·çµæ´»ã€‚&lt;/p&gt;
&lt;h2 id="5-è¿­ä»£å™¨çš„ç§˜å¯†pairs-ä¸-ipairs"&gt;5. è¿­ä»£å™¨çš„ç§˜å¯†ï¼špairs ä¸ ipairs
&lt;/h2&gt;&lt;p&gt;æˆ‘ä»¬åœ¨å†™ Lua æ—¶å¸¸ç”¨çš„ä¸¤ç§éå†æ–¹å¼ï¼Œå…¶åº•å±‚æ€§èƒ½å·®å¼‚å·¨å¤§ã€‚&lt;/p&gt;
&lt;h3 id="51-ipairsåºåˆ—ä¸“ç”¨"&gt;5.1 ipairsï¼šåºåˆ—ä¸“ç”¨
&lt;/h3&gt;&lt;p&gt;&lt;code&gt;ipairs&lt;/code&gt; æ˜¯ä¸º**åºåˆ—ï¼ˆSequenceï¼‰**é‡èº«å®šåšçš„ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;é€»è¾‘&lt;/strong&gt;ï¼šç»´æŠ¤ä¸€ä¸ªå†…éƒ¨è®¡æ•°å™¨ &lt;code&gt;i&lt;/code&gt;ï¼Œä» 1 å¼€å§‹é€’å¢ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¯»å€&lt;/strong&gt;ï¼šLua å†…éƒ¨ä¼šå…ˆåˆ¤æ–­ &lt;code&gt;i&lt;/code&gt; æ˜¯å¦åœ¨ &lt;code&gt;array&lt;/code&gt; çš„èŒƒå›´å†…ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æºç ä½è¯ (&lt;code&gt;luaH_getint&lt;/code&gt;)&lt;/strong&gt;ï¼š è¿™æ˜¯æ•´æ•°æŸ¥æ‰¾çš„å…¥å£å‡½æ•°ï¼Œæ¸…æ™°å±•ç¤ºäº†â€œå…ˆæŸ¥æ•°ç»„ï¼Œå†æŸ¥å“ˆå¸Œâ€çš„é€»è¾‘ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;span class="lnt"&gt;17
&lt;/span&gt;&lt;span class="lnt"&gt;18
&lt;/span&gt;&lt;span class="lnt"&gt;19
&lt;/span&gt;&lt;span class="lnt"&gt;20
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-gdscript3" data-lang="gdscript3"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="k"&gt;const&lt;/span&gt; &lt;span class="n"&gt;TValue&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;luaH_getint&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Table&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;lua_Integer&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="mf"&gt;1.&lt;/span&gt; &lt;span class="err"&gt;æ•°ç»„éƒ¨åˆ†å¿«é€ŸæŸ¥æ‰¾&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Fast&lt;/span&gt; &lt;span class="ne"&gt;Path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;è¿™é‡Œçš„&lt;/span&gt; &lt;span class="n"&gt;alimit&lt;/span&gt; &lt;span class="err"&gt;å°±æ˜¯æ•°ç»„çš„é€»è¾‘å¤§å°&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;l_castS2U&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;alimit&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;-&amp;gt;&lt;/span&gt;&lt;span class="n"&gt;array&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;];&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="mf"&gt;2.&lt;/span&gt; &lt;span class="err"&gt;å“ˆå¸Œéƒ¨åˆ†æŸ¥æ‰¾&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Slow&lt;/span&gt; &lt;span class="ne"&gt;Path&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;Node&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;hashint&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="p"&gt;(;;)&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ttisinteger&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gkey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class="n"&gt;ivalue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;gkey&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;gval&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;æ‰¾åˆ°äº†&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="ne"&gt;int&lt;/span&gt; &lt;span class="n"&gt;nx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;gnext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;nx&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="n"&gt;nx&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt; &lt;span class="o"&gt;/*&lt;/span&gt; &lt;span class="err"&gt;æ²¿ç€å†²çªé“¾æŸ¥æ‰¾&lt;/span&gt; &lt;span class="o"&gt;*/&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;luaO_nilobject&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;åœ¨èŒƒå›´å†…&lt;/strong&gt;ï¼šç›´æ¥é€šè¿‡æŒ‡é’ˆåç§» &lt;code&gt;array[i]&lt;/code&gt; è¯»å–ï¼Œè¿™å‡ ä¹å°±æ˜¯ C è¯­è¨€è®¿é—®æ•°ç»„çš„é€Ÿåº¦ï¼Œ&lt;strong&gt;æå¿«&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä¸åœ¨èŒƒå›´å†…&lt;/strong&gt;ï¼šæ‰å»æŸ¥ Hash è¡¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="52-pairså…¨é‡éå†"&gt;5.2 pairsï¼šå…¨é‡éå†
&lt;/h3&gt;&lt;p&gt;&lt;code&gt;pairs&lt;/code&gt; ä½¿ç”¨çš„æ˜¯ &lt;code&gt;lua_next&lt;/code&gt; å‡½æ•°ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æµç¨‹&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;å…ˆéå†æ•°ç»„éƒ¨åˆ†&lt;/strong&gt;ï¼šä»ä¸‹æ ‡ 0 åˆ° &lt;code&gt;sizearray&lt;/code&gt; çº¿æ€§æ‰«æã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å†éå†å“ˆå¸Œéƒ¨åˆ†&lt;/strong&gt;ï¼šä»å“ˆå¸Œæ¡¶çš„ç¬¬ä¸€ä¸ªä½ç½®æ‰«æåˆ°æœ€åä¸€ä¸ªä½ç½®ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;é¡ºåºé—®é¢˜&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;å¯¹äº&lt;strong&gt;çº¯æ•°ç»„&lt;/strong&gt;è¡¨ï¼ˆå¦‚ &lt;code&gt;{10, 20, 30}&lt;/code&gt;ï¼‰ï¼Œå› ä¸ºåªæ‰«ææ•°ç»„éƒ¨åˆ†ï¼Œè¾“å‡ºçœ‹èµ·æ¥æ˜¯æœ‰åºçš„ã€‚&lt;/li&gt;
&lt;li&gt;ä¸€æ—¦æ¶‰åŠå“ˆå¸Œéƒ¨åˆ†ï¼Œé¡ºåºå°±æ˜¯&lt;strong&gt;ä¹±åº&lt;/strong&gt;çš„ã€‚è¿™æ˜¯å› ä¸º Key åœ¨å“ˆå¸Œè¡¨ä¸­çš„ç‰©ç†ä½ç½®å–å†³äº Hash ç®—æ³•å’Œå†²çªæ—¶çš„æ’å…¥é¡ºåºï¼Œä¸é€»è¾‘é¡ºåºæ— å…³ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;é¿å‘æŒ‡å—&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ä¸è¦ä¾èµ– &lt;code&gt;pairs&lt;/code&gt; çš„éå†é¡ºåºï¼Œé™¤éä½ ç¡®è®¤è¡¨æ˜¯çº¯æ•°ç»„ä¸”å°šæœªå‘ç”Ÿè¿‡å¤æ‚çš„ Rehashã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id="6-æ€»ç»“"&gt;6. æ€»ç»“
&lt;/h2&gt;&lt;p&gt;Lua Table çš„æºç å®ç°ä½“ç°äº†æå¼ºçš„&lt;strong&gt;å·¥ç¨‹å®ç”¨ä¸»ä¹‰&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;æ··åˆç»“æ„&lt;/strong&gt;å¹³è¡¡äº†æ•°ç»„çš„ $O(1)$ è®¿é—®å’Œå“ˆå¸Œè¡¨çš„ç¨€ç–çµæ´»æ€§ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;50% åˆ©ç”¨ç‡åŸåˆ™&lt;/strong&gt;ä¿è¯äº†æ•°ç»„ç©ºé—´ä¸ä¼šè¢«è¿‡åº¦æµªè´¹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;lastfree å†²çªè§£å†³&lt;/strong&gt;æœ€å¤§åŒ–åˆ©ç”¨äº†é¢„åˆ†é…å†…å­˜ï¼Œå‡å°‘äº† &lt;code&gt;malloc&lt;/code&gt; è°ƒç”¨çš„å¼€é”€ã€‚&lt;/li&gt;
&lt;/ol&gt;</description></item><item><title>Lua æ•°æ®ç±»å‹ä¸GCå¯¹è±¡</title><link>https://WeissGoat.github.io/WBlog/p/lua-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8Egc%E5%AF%B9%E8%B1%A1/</link><pubDate>Mon, 05 Feb 2024 18:00:00 +0800</pubDate><guid>https://WeissGoat.github.io/WBlog/p/lua-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%B8%8Egc%E5%AF%B9%E8%B1%A1/</guid><description>&lt;h1 id="lua-æºç æ‰‹è®°æ•°æ®ç±»å‹ä¸éšè—çš„-gc-å¯¹è±¡"&gt;Lua æºç æ‰‹è®°ï¼šæ•°æ®ç±»å‹ä¸éšè—çš„ GC å¯¹è±¡
&lt;/h1&gt;&lt;p&gt;æœ€è¿‘åœ¨å•ƒ Lua çš„æºç ï¼Œä¸»è¦æƒ³ææ¸…æ¥šä¸€ä¸ªé—®é¢˜ï¼šå½“æˆ‘ä»¬å†™ä¸‹ &lt;code&gt;local a = 1&lt;/code&gt; éšååˆå†™ &lt;code&gt;a = &amp;quot;hello&amp;quot;&lt;/code&gt; æ—¶ï¼ŒLua è™šæ‹Ÿæœºåº•å±‚åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ&lt;/p&gt;
&lt;p&gt;ä½œä¸ºä¸€ä¸ª Lua å¼€å‘è€…ï¼Œæˆ‘ä»¬ä¹ æƒ¯äº†â€œå˜é‡æ— ç±»å‹ï¼Œå€¼æœ‰ç±»å‹â€çš„è‡ªç”±ã€‚ä½†åœ¨ C è¯­è¨€ç¼–å†™çš„è™šæ‹Ÿæœºåº•å±‚ï¼Œå†…å­˜æ˜¯ä¸¥è‹›ä¸”é™æ€çš„ã€‚Lua æ˜¯å¦‚ä½•åœ¨ä¸€ä¸ªé™æ€çš„ C ç»“æ„ä½“ä¸­å¡è¿›åƒå˜ä¸‡åŒ–çš„åŠ¨æ€ç±»å‹çš„ï¼Ÿå“ªäº›æ•°æ®æ˜¯â€œæ´»â€åœ¨æ ˆä¸Šçš„ï¼Œå“ªäº›åˆæ˜¯éœ€è¦åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰è´¹å¿ƒç…§é¡¾çš„ï¼Ÿ&lt;/p&gt;
&lt;p&gt;æœ¬æ–‡å°†å¸¦ä½ é€šè¿‡â€œæ˜¾å¾®é•œâ€è§†è§’ï¼Œä»åº•å±‚çš„ &lt;code&gt;TValue&lt;/code&gt; ç»“æ„å¼€å§‹ï¼Œé‡æ–°å®¡è§† Lua çš„æ•°æ®ç±»å‹ç³»ç»Ÿä¸å†…å­˜ç®¡ç†ç­–ç•¥ã€‚&lt;/p&gt;
&lt;h2 id="ä¸€-æºç æ­ç§˜ä¸‡ç‰©ä¹‹å®¹å™¨-tvalue"&gt;ä¸€ã€ æºç æ­ç§˜ï¼šä¸‡ç‰©ä¹‹å®¹å™¨ TValue
&lt;/h2&gt;&lt;p&gt;åœ¨ Lua è™šæ‹Ÿæœºä¸­ï¼Œå¹¶æ²¡æœ‰â€œæ•´æ•°å˜é‡â€æˆ–â€œå­—ç¬¦ä¸²å˜é‡â€çš„æ¦‚å¿µã€‚æ— è®ºæ˜¯å…¨å±€å˜é‡ã€å±€éƒ¨å˜é‡ï¼Œè¿˜æ˜¯ Table ä¸­çš„ä¸€ä¸ªæ§½ä½ï¼Œåœ¨åº•å±‚ C æºç ä¸­ï¼Œå®ƒä»¬éƒ½ç”±ä¸€ä¸ªç»Ÿä¸€çš„æ•°æ®ç»“æ„è¡¨ç¤ºï¼š&lt;strong&gt;&lt;code&gt;TValue&lt;/code&gt;&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;code&gt;TValue&lt;/code&gt; çš„è®¾è®¡å®Œç¾ä½“ç°äº† Lua çš„æ ¸å¿ƒå“²å­¦ï¼š&lt;strong&gt;Tagged Unionï¼ˆå¸¦æ ‡ç­¾çš„è”åˆä½“ï¼‰&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;h3 id="11-æ ¸å¿ƒç»“æ„å®šä¹‰"&gt;1.1 æ ¸å¿ƒç»“æ„å®šä¹‰
&lt;/h3&gt;&lt;p&gt;æˆ‘ä»¬å¯ä»¥å°† &lt;code&gt;TValue&lt;/code&gt; æƒ³è±¡æˆä¸€ä¸ªæ ‡å‡†åŒ–çš„â€œé€šç”¨å¿«é€’ç›’â€ï¼Œå®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;æ ‡ç­¾ (Tag)&lt;/strong&gt;ï¼šè¯´æ˜ä¹¦ï¼Œæ ‡è®°ç›’å­é‡Œè£…çš„æ˜¯ä»€ä¹ˆç±»å‹ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å€¼ (Value)&lt;/strong&gt;ï¼šå®é™…è´§ç‰©ï¼Œæˆ–è€…æŒ‡å‘è´§ç‰©çš„å–è´§å•ï¼ˆæŒ‡é’ˆï¼‰ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è®©æˆ‘ä»¬çœ‹çœ‹ Lua 5.3+ æºç ä¸­çš„æ ¸å¿ƒå®šä¹‰ï¼ˆä½äº &lt;code&gt;lobject.h&lt;/code&gt;ï¼‰ï¼š&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt; 1
&lt;/span&gt;&lt;span class="lnt"&gt; 2
&lt;/span&gt;&lt;span class="lnt"&gt; 3
&lt;/span&gt;&lt;span class="lnt"&gt; 4
&lt;/span&gt;&lt;span class="lnt"&gt; 5
&lt;/span&gt;&lt;span class="lnt"&gt; 6
&lt;/span&gt;&lt;span class="lnt"&gt; 7
&lt;/span&gt;&lt;span class="lnt"&gt; 8
&lt;/span&gt;&lt;span class="lnt"&gt; 9
&lt;/span&gt;&lt;span class="lnt"&gt;10
&lt;/span&gt;&lt;span class="lnt"&gt;11
&lt;/span&gt;&lt;span class="lnt"&gt;12
&lt;/span&gt;&lt;span class="lnt"&gt;13
&lt;/span&gt;&lt;span class="lnt"&gt;14
&lt;/span&gt;&lt;span class="lnt"&gt;15
&lt;/span&gt;&lt;span class="lnt"&gt;16
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/* é€šç”¨å€¼è”åˆä½“ï¼šåŒä¸€æ—¶é—´åªèƒ½å­˜ä¸€ç§æ•°æ®ï¼Œä¿è¯å†…å­˜ç´§å‡‘ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;typedef union Value {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; GCObject *gc; /* collectable objects: å¤æ‚å¯¹è±¡ï¼ˆTable, String...ï¼‰å­˜æŒ‡é’ˆ -&amp;gt; æŒ‡å‘å †å†…å­˜ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; void *p; /* light userdata: å­˜çº¯æŒ‡é’ˆ -&amp;gt; ç›´æ¥å­˜åœ°å€ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; int b; /* boolean: å­˜ 0 æˆ– 1 -&amp;gt; ç›´æ¥å­˜æ•´æ•° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; lua_CFunction f; /* light C functions: è½»é‡çº§ C å‡½æ•° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; lua_Integer i; /* integer numbers: æ•´æ•° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; lua_Number n; /* float numbers: æµ®ç‚¹æ•° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;} Value;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/* Lua ä¸­çš„é€šç”¨å€¼ç»“æ„ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;#define TValuefields Value value_; int tt_
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;typedef struct TValue {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; TValuefields;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;} TValue;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h3 id="12-å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„"&gt;1.2 å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ
&lt;/h3&gt;&lt;p&gt;å½“ä½ å†™ &lt;code&gt;local a = 10&lt;/code&gt; æ—¶ï¼ŒLua è™šæ‹Ÿæœºåšçš„äº‹æƒ…æ˜¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ‰¾åˆ° &lt;code&gt;a&lt;/code&gt; å¯¹åº”çš„æ ˆæ§½ä½ï¼ˆä¸€ä¸ª &lt;code&gt;TValue&lt;/code&gt; å†…å­˜å—ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;å°† &lt;code&gt;tt_&lt;/code&gt; (æ ‡ç­¾) è®¾ä¸º &lt;code&gt;LUA_TNUMINT&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å°† &lt;code&gt;value_.i&lt;/code&gt; (æ•°æ®) è®¾ä¸º &lt;code&gt;10&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å½“ä½ éšåå†™ &lt;code&gt;a = {}&lt;/code&gt; æ—¶ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è™šæ‹Ÿæœºåœ¨&lt;strong&gt;å †å†…å­˜&lt;/strong&gt;ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ Table å¯¹è±¡ã€‚&lt;/li&gt;
&lt;li&gt;å°† &lt;code&gt;a&lt;/code&gt; çš„ &lt;code&gt;tt_&lt;/code&gt; æ›´æ–°ä¸º &lt;code&gt;LUA_TTABLE&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;å°† &lt;code&gt;value_.gc&lt;/code&gt; æ›´æ–°ä¸ºæŒ‡å‘é‚£ä¸ª Table çš„æŒ‡é’ˆã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;è¿™ç§è®¾è®¡ä½¿å¾— Lua çš„å˜é‡å¯ä»¥æ‰¿è½½ä»»ä½•ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªæºå¸¦äº†ç±»å‹æ ‡ç­¾çš„å®¹å™¨ã€‚&lt;/p&gt;
&lt;h2 id="äºŒ-lua-çš„-8-ç§åŸºæœ¬æ•°æ®ç±»å‹å†…å­˜è§†è§’"&gt;äºŒã€ Lua çš„ 8 ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼šå†…å­˜è§†è§’
&lt;/h2&gt;&lt;p&gt;åŸºäº &lt;code&gt;TValue&lt;/code&gt; çš„å­˜å‚¨æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°† Lua æš´éœ²ç»™å¼€å‘è€…çš„ 8 ç§æ•°æ®ç±»å‹åˆ†ä¸ºä¸‰å¤§ç±»ã€‚è¿™ç›´æ¥å…³ç³»åˆ°èµ‹å€¼æ“ä½œçš„æ€§èƒ½å’Œ GC çš„å‹åŠ›ã€‚&lt;/p&gt;
&lt;h3 id="1-å€¼ç±»å‹-value-types--æ ˆä¸Šçš„åŸä½æ°‘"&gt;1. å€¼ç±»å‹ (Value Types) â€”â€” æ ˆä¸Šçš„åŸä½æ°‘
&lt;/h3&gt;&lt;p&gt;è¿™äº›ç±»å‹çš„æ•°æ®éå¸¸å°ï¼Œç›´æ¥å­˜å‚¨åœ¨ &lt;code&gt;TValue&lt;/code&gt; ç»“æ„ä½“å†…éƒ¨ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;nil (ç©º)&lt;/strong&gt;ï¼šè¡¨ç¤ºâ€œæ— æ•ˆå€¼â€ã€‚å…¨å±€å˜é‡é»˜è®¤å€¼ã€‚èµ‹å€¼ &lt;code&gt;nil&lt;/code&gt; ç­‰åŒäºåˆ é™¤ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;boolean (å¸ƒå°”)&lt;/strong&gt;ï¼šåªæœ‰ &lt;code&gt;true&lt;/code&gt; å’Œ &lt;code&gt;false&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;em&gt;æ³¨æ„&lt;/em&gt;ï¼šLua ä¸­åªæœ‰ &lt;code&gt;false&lt;/code&gt; å’Œ &lt;code&gt;nil&lt;/code&gt; ä¸ºå‡ï¼Œæ•°å­— &lt;code&gt;0&lt;/code&gt; æ˜¯çœŸã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;number (æ•°å€¼)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;Lua 5.3+ åˆ†ä¸º Integer (64ä½æ•´å‹) å’Œ Float (åŒç²¾åº¦æµ®ç‚¹)ã€‚&lt;/li&gt;
&lt;li&gt;VM ä¼šè‡ªåŠ¨å¤„ç†è½¬æ¢ï¼Œé€šå¸¸æ— éœ€æ„ŸçŸ¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;light userdata (è½»é‡ç”¨æˆ·æ•°æ®)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç‰¹ä¾‹&lt;/strong&gt;ï¼šå®ƒæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¯ç²¹çš„ C æŒ‡é’ˆ (&lt;code&gt;void *&lt;/code&gt;)ã€‚Lua æŠŠå®ƒå½“ä½œä¸€ä¸ªæ•°å­—å¤„ç†ï¼Œ&lt;strong&gt;ä¸ç®¡ç†&lt;/strong&gt;å®ƒçš„ç”Ÿå‘½å‘¨æœŸï¼ˆç”Ÿæ­»ç”± C ç«¯ä»£ç è´Ÿè´£ï¼‰ã€‚è¿™æ˜¯é«˜æ€§èƒ½äº¤äº’çš„åˆ©å™¨ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="2-gc-ç±»å‹-gcobjects--å †ä¸Šçš„ä½å®¢"&gt;2. GC ç±»å‹ (GCObjects) â€”â€” å †ä¸Šçš„ä½å®¢
&lt;/h3&gt;&lt;p&gt;è¿™äº›ç±»å‹æ•°æ®é‡å¤§ä¸”ç»“æ„å¤æ‚ï¼Œ&lt;code&gt;TValue&lt;/code&gt; åªå­˜æŒ‡é’ˆï¼ˆ&lt;code&gt;value_.gc&lt;/code&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;string (å­—ç¬¦ä¸²)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;ä¸å¯å˜å­—ç¬¦åºåˆ—ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;String Interning (å­—ç¬¦ä¸²é©»ç•™)&lt;/strong&gt;ï¼šLua ä¼šå¯¹çŸ­å­—ç¬¦ä¸²è¿›è¡Œå”¯ä¸€åŒ–å¤„ç†ï¼Œç›¸åŒå†…å®¹çš„çŸ­å­—ç¬¦ä¸²åœ¨å…¨å±€åªæœ‰ä¸€ä»½å†…å­˜ï¼Œæ¯”è¾ƒæ—¶åªéœ€æ¯”è¾ƒæŒ‡é’ˆåœ°å€ï¼Œé€Ÿåº¦æå¿«ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;table (è¡¨)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;Lua å”¯ä¸€çš„æ•°æ®ç»“æ„ã€‚&lt;/li&gt;
&lt;li&gt;æ—¢æ˜¯æ•°ç»„ï¼ˆArrayï¼Œä¸‹æ ‡ä»1å¼€å§‹ï¼‰ï¼Œä¹Ÿæ˜¯å­—å…¸ï¼ˆHash Mapï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;function (å‡½æ•°)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;ç¬¬ä¸€ç±»å€¼ï¼ˆFirst-classï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;åŒ…å« C å‡½æ•°å’Œ Lua å‡½æ•°ï¼ˆé—­åŒ…ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;thread (çº¿ç¨‹)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;åç¨‹ (Coroutine) çš„å®ç°åŸºç¡€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;userdata (å®Œå…¨ç”¨æˆ·æ•°æ®)&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;ç”± Lua è™šæ‹Ÿæœºåˆ†é…å†…å­˜çš„ä¸€å—åŸå§‹å†…å­˜åŒºåŸŸï¼Œæ”¯æŒ &lt;code&gt;__gc&lt;/code&gt; å…ƒæ–¹æ³•ææ„ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="ä¸‰-è°åœ¨å‚ä¸-gcå†…å­˜ç®¡ç†æ­ç§˜"&gt;ä¸‰ã€ è°åœ¨å‚ä¸ GCï¼Ÿï¼ˆå†…å­˜ç®¡ç†æ­ç§˜ï¼‰
&lt;/h2&gt;&lt;p&gt;åœ¨ Lua ä¸­ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰å˜é‡éƒ½éœ€è¦åƒåœ¾å›æ”¶å™¨ï¼ˆGarbage Collection, GCï¼‰æ“å¿ƒã€‚&lt;/p&gt;
&lt;h3 id="31-gcobject-çš„ç§˜å¯†"&gt;3.1 GCObject çš„ç§˜å¯†
&lt;/h3&gt;&lt;p&gt;æ‰€æœ‰éœ€è¦è¢« GC ç®¡ç†çš„å¯¹è±¡ï¼Œåœ¨ C å±‚é¢éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„å¤´éƒ¨ï¼Œå«åš &lt;code&gt;CommonHeader&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;div class="chroma"&gt;
&lt;table class="lntable"&gt;&lt;tr&gt;&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code&gt;&lt;span class="lnt"&gt;1
&lt;/span&gt;&lt;span class="lnt"&gt;2
&lt;/span&gt;&lt;span class="lnt"&gt;3
&lt;/span&gt;&lt;span class="lnt"&gt;4
&lt;/span&gt;&lt;span class="lnt"&gt;5
&lt;/span&gt;&lt;span class="lnt"&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class="lntd"&gt;
&lt;pre tabindex="0" class="chroma"&gt;&lt;code class="language-fallback" data-lang="fallback"&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;/* æ‰€æœ‰ GC å¯¹è±¡é€šç”¨çš„å¤´éƒ¨ */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;#define CommonHeader GCObject *next; lu_byte tt; lu_byte marked
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;struct GCObject {
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt; CommonHeader; /* åŒ…å«ï¼šé“¾è¡¨æŒ‡é’ˆã€ç±»å‹æ ‡ç­¾ã€GC é¢œè‰²æ ‡è®° */
&lt;/span&gt;&lt;/span&gt;&lt;span class="line"&gt;&lt;span class="cl"&gt;};
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆ Lua å¯ä»¥ç»Ÿä¸€ç®¡ç†ä¸åŒç±»å‹çš„å¯¹è±¡ï¼šå› ä¸ºå®ƒä»¬å¼ºè½¬ä¸º &lt;code&gt;GCObject*&lt;/code&gt; åï¼Œå¤´éƒ¨ç»“æ„æ˜¯ä¸€æ ·çš„ï¼ŒGC åªéœ€è¦æ‰«æè¿™ä¸ªå¤´éƒ¨é“¾è¡¨å³å¯ã€‚&lt;/p&gt;
&lt;h3 id="32-åŒºåˆ†æ ‡å‡†"&gt;3.2 åŒºåˆ†æ ‡å‡†
&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä¸å‚ä¸ GC&lt;/strong&gt;ï¼š&lt;code&gt;nil&lt;/code&gt;, &lt;code&gt;boolean&lt;/code&gt;, &lt;code&gt;number&lt;/code&gt;, &lt;code&gt;light userdata&lt;/code&gt;ã€‚å®ƒä»¬éšæ ˆå¸§ç”Ÿç­ï¼Œæ— éœ€ GC ä»‹å…¥ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å‚ä¸ GC&lt;/strong&gt;ï¼š&lt;code&gt;string&lt;/code&gt;, &lt;code&gt;table&lt;/code&gt;, &lt;code&gt;function&lt;/code&gt;, &lt;code&gt;userdata&lt;/code&gt;, &lt;code&gt;thread&lt;/code&gt;ã€‚å®ƒä»¬åœ¨å †ä¸Šåˆ†é…ï¼Œéœ€è¦é€šè¿‡æ ‡è®°-æ¸…é™¤ï¼ˆMark-and-Sweepï¼‰ç®—æ³•å›æ”¶ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="å››-éšå½¢çš„-gc-å¯¹è±¡proto-ä¸-upval"&gt;å››ã€ éšå½¢çš„ GC å¯¹è±¡ï¼šProto ä¸ UpVal
&lt;/h2&gt;&lt;p&gt;é™¤äº†ä¸Šè¿°æˆ‘ä»¬åœ¨ Lua ä»£ç ä¸­èƒ½ç›´æ¥æ“ä½œçš„ç±»å‹å¤–ï¼ŒLua è™šæ‹Ÿæœºåº•å±‚è¿˜æœ‰ä¸¤ä¸ªéå¸¸å…³é”®çš„å†…éƒ¨å¯¹è±¡ä¹Ÿæ˜¯ç”± GC ç®¡ç†çš„ã€‚&lt;strong&gt;ç†è§£å®ƒä»¬ï¼Œæ˜¯æŒæ¡ Lua é—­åŒ… (Closure) æœºåˆ¶çš„é’¥åŒ™ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id="1-proto-å‡½æ•°åŸå‹--é™æ€çš„è“å›¾"&gt;1. Proto (å‡½æ•°åŸå‹) â€”â€” é™æ€çš„è“å›¾
&lt;/h3&gt;&lt;p&gt;ä½ å¯ä»¥æŠŠ &lt;code&gt;Proto&lt;/code&gt; çœ‹ä½œæ˜¯**â€œå‡½æ•°çš„ç¼–è¯‘æ¨¡å…·â€**ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å®ƒæ˜¯ä»€ä¹ˆ&lt;/strong&gt;ï¼šå½“ Lua ç¼–è¯‘å™¨ç¼–è¯‘ä¸€æ®µä»£ç æ—¶ï¼Œç”Ÿæˆçš„å­—èŠ‚ç ï¼ˆBytecodeï¼‰ã€å¸¸é‡è¡¨ï¼ˆConstantsï¼‰ã€è°ƒè¯•ä¿¡æ¯ç­‰&lt;strong&gt;é™æ€æ•°æ®&lt;/strong&gt;ï¼Œéƒ½è¢«æ‰“åŒ…å­˜å‚¨åœ¨ä¸€ä¸ª &lt;code&gt;Proto&lt;/code&gt; å¯¹è±¡ä¸­ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç”Ÿå‘½å‘¨æœŸ&lt;/strong&gt;ï¼šè™½ç„¶å®ƒæ˜¯é™æ€çš„ï¼Œä½†å½“ä½ ä½¿ç”¨ &lt;code&gt;load&lt;/code&gt; åŠ è½½ä¸€æ®µä»£ç å—æ—¶ï¼Œç³»ç»Ÿä¼šç”Ÿæˆå¯¹åº”çš„ &lt;code&gt;Proto&lt;/code&gt;ã€‚å¦‚æœè¿™ä¸ªæ¨¡å—è¢«å¸è½½ï¼Œæˆ–è€…æ²¡æœ‰ä»»ä½•é—­åŒ…å†ä½¿ç”¨è¿™ä¸ªæ¨¡å…·ï¼Œ&lt;code&gt;Proto&lt;/code&gt; å°±éœ€è¦è¢«å›æ”¶ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="2-upval-ä¸Šå€¼å¯¹è±¡--é—­åŒ…çš„çµé­‚"&gt;2. UpVal (ä¸Šå€¼å¯¹è±¡) â€”â€” é—­åŒ…çš„çµé­‚
&lt;/h3&gt;&lt;p&gt;è¿™æ˜¯ Lua é—­åŒ…æœºåˆ¶æœ€ç²¾å¦™çš„åœ°æ–¹ã€‚&lt;code&gt;UpVal&lt;/code&gt; æ˜¯ç‹¬ç«‹äºå‡½æ•°æ ˆå¸§å­˜åœ¨çš„å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨é—­åŒ…æ•è·çš„å¤–éƒ¨å±€éƒ¨å˜é‡ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ&lt;/strong&gt; å½“ä¸€ä¸ªå‡½æ•°è¿”å›æ—¶ï¼Œå®ƒçš„æ ˆå¸§ä¼šè¢«é”€æ¯ï¼ŒåŸæœ¬å­˜åœ¨æ ˆä¸Šçš„å±€éƒ¨å˜é‡ä¹Ÿå°±æ¶ˆå¤±äº†ã€‚å¦‚æœå†…éƒ¨å‡½æ•°ï¼ˆé—­åŒ…ï¼‰è¿˜å¼•ç”¨äº†è¿™ä¸ªå˜é‡ï¼Œæ€ä¹ˆåŠï¼Ÿ&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Open vs Closed çŠ¶æ€&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Open (å¼€æ”¾)&lt;/strong&gt;ï¼šå½“çˆ¶å‡½æ•°è¿˜åœ¨è¿è¡Œæ—¶ï¼Œè¢«æ•è·çš„å˜é‡è¿˜åœ¨æ ˆä¸Šã€‚æ­¤æ—¶ &lt;code&gt;UpVal&lt;/code&gt; åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘æ ˆä¸Šçš„é‚£ä¸ªä½ç½®ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Closed (å…³é—­)&lt;/strong&gt;ï¼šå½“çˆ¶å‡½æ•°è¿”å›ï¼Œæ ˆå³å°†é”€æ¯æ—¶ï¼ŒLua ä¼šå°†å˜é‡çš„å€¼&lt;strong&gt;å¤åˆ¶&lt;/strong&gt;åˆ° &lt;code&gt;UpVal&lt;/code&gt; å¯¹è±¡å†…éƒ¨ï¼ˆå †å†…å­˜ï¼‰ï¼Œå¹¶å°† &lt;code&gt;UpVal&lt;/code&gt; æŒ‡é’ˆæŒ‡å‘è‡ªå·±ã€‚è¿™å°±å®ç°äº†â€œå˜é‡é€ƒé€¸â€ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;å…¬å¼ç±»æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Lua Function (è¿è¡Œæ—¶é—­åŒ…) = Proto (é™æ€ä»£ç é€»è¾‘) + UpVals (åŠ¨æ€ç¯å¢ƒä¸Šä¸‹æ–‡)&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸¤ä¸ªé—­åŒ…å¯ä»¥ä½¿ç”¨åŒä¸€ä»½ä»£ç ï¼ˆåŒä¸€ä¸ª Protoï¼‰ï¼Œå´æ‹¥æœ‰ä¸åŒçš„çŠ¶æ€ï¼ˆä¸åŒçš„ UpValsï¼‰ã€‚&lt;/p&gt;
&lt;h2 id="äº”-æ€»ç»“ä¸æ€§èƒ½å»ºè®®"&gt;äº”ã€ æ€»ç»“ä¸æ€§èƒ½å»ºè®®
&lt;/h2&gt;&lt;p&gt;é€šè¿‡é‡æ–°å®¡è§† &lt;code&gt;TValue&lt;/code&gt; å’Œ GC å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€äº›å†™å‡ºé«˜æ€§èƒ½ Lua ä»£ç çš„åŸåˆ™ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;èµ‹å€¼å¼€é”€&lt;/strong&gt;ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;number/boolean&lt;/code&gt; èµ‹å€¼æ˜¯å†…å­˜æ‹·è´ï¼ˆæå¿«ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;table/function&lt;/code&gt; èµ‹å€¼æ˜¯æŒ‡é’ˆæ‹·è´ï¼ˆæå¿«ï¼‰ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä½†æ˜¯&lt;/strong&gt;ï¼Œåˆ›å»º &lt;code&gt;table&lt;/code&gt; (&lt;code&gt;{}&lt;/code&gt;) æˆ–é—­åŒ… (&lt;code&gt;function() end&lt;/code&gt;) æ˜¯å †å†…å­˜åˆ†é…ï¼Œç›¸å¯¹è¾ƒæ…¢ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;ol start="2"&gt;
&lt;li&gt;&lt;strong&gt;Light Userdata çš„å¦™ç”¨&lt;/strong&gt;ï¼š å¦‚æœä½ åªéœ€è¦åœ¨ Lua é‡ŒæŒæœ‰ä¸€ä¸ª C++ å¯¹è±¡çš„å¥æŸ„ï¼Œä¸”ç”Ÿå‘½å‘¨æœŸç”± C++ ç®¡ç†ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨ &lt;code&gt;light userdata&lt;/code&gt;ã€‚å®ƒå¯ä»¥å®Œå…¨é¿å¼€ GC çš„æ‰«æå’Œè¿½è¸ªå¼€é”€ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é—­åŒ…çš„ä»£ä»·&lt;/strong&gt;ï¼š æ¯åˆ›å»ºä¸€ä¸ªæ–°çš„é—­åŒ…ï¼Œä¸ä»…ä¼šåˆ›å»ºä¸€ä¸ª &lt;code&gt;Function&lt;/code&gt; å¯¹è±¡ï¼Œå¦‚æœæ¶‰åŠæ–°çš„å¤–éƒ¨å˜é‡æ•è·ï¼Œè¿˜å¯èƒ½åˆ›å»ºæ–°çš„ &lt;code&gt;UpVal&lt;/code&gt; å¯¹è±¡ã€‚åœ¨æé«˜é¢‘è°ƒç”¨çš„åœºæ™¯ä¸‹ï¼ˆå¦‚æ¸¸æˆæ¯å¸§ Updateï¼‰ï¼Œåº”å°½é‡é¿å…åœ¨å¾ªç¯å†…åˆ›å»ºåŒ¿åå‡½æ•°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;GC å‹åŠ›&lt;/strong&gt;ï¼š å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆäº§ç”Ÿæ–° String å¯¹è±¡ï¼‰å’Œè¡¨çš„é¢‘ç¹åˆ›å»ºé”€æ¯æ˜¯ GC å¡é¡¿çš„ä¸¤å¤§å…ƒå‡¶ã€‚åœ¨æ€§èƒ½æ•æ„ŸåŒºï¼Œå¤ç”¨ Tableï¼ˆObject Poolingï¼‰æ°¸è¿œæ˜¯ç‹é“ã€‚&lt;/li&gt;
&lt;/ol&gt;</description></item><item><title>hello world</title><link>https://WeissGoat.github.io/WBlog/p/hello-world/</link><pubDate>Mon, 29 Jan 2024 00:00:00 +0000</pubDate><guid>https://WeissGoat.github.io/WBlog/p/hello-world/</guid><description>&lt;p&gt;å¾ˆå¹¸è¿ç”Ÿæ´»åœ¨ä¸€ä¸ªæŠ€æœ¯çˆ†ç‚¸çš„æ—¶ä»£, æ„Ÿè§‰æœªæ¥å……æ»¡ç€å¯èƒ½æ€§&lt;/p&gt;
&lt;p&gt;åœ¨è¿™é‡Œå±•ç¤ºæˆ‘çš„ç”Ÿæ´», æˆ‘çš„æ€è€ƒ, æˆ‘çš„æˆé•¿&lt;/p&gt;</description></item><item><title>å…³äº</title><link>https://WeissGoat.github.io/WBlog/%E5%85%B3%E4%BA%8E/</link><pubDate>Tue, 26 Jan 2021 00:00:00 +0000</pubDate><guid>https://WeissGoat.github.io/WBlog/%E5%85%B3%E4%BA%8E/</guid><description>&lt;p&gt;å¾ˆå¹¸è¿ç”Ÿæ´»åœ¨ä¸€ä¸ªæŠ€æœ¯çˆ†ç‚¸çš„æ—¶ä»£, æ„Ÿè§‰æœªæ¥å……æ»¡ç€å¯èƒ½æ€§&lt;/p&gt;
&lt;p&gt;åœ¨è¿™é‡Œå±•ç¤ºæˆ‘çš„ç”Ÿæ´», æˆ‘çš„æ€è€ƒ, æˆ‘çš„æˆé•¿&lt;/p&gt;</description></item><item><title>å½’æ¡£</title><link>https://WeissGoat.github.io/WBlog/archives/</link><pubDate>Tue, 28 May 2019 00:00:00 +0000</pubDate><guid>https://WeissGoat.github.io/WBlog/archives/</guid><description/></item><item><title>æœç´¢</title><link>https://WeissGoat.github.io/WBlog/search/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://WeissGoat.github.io/WBlog/search/</guid><description/></item></channel></rss>